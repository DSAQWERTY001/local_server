/* eslint-disable node/no-deprecated-api */

'use strict'

var test = require('tape')

var buffer = require('buffer')

var index = require('./')
var safer = require('./safer')
var dangerous = require('./dangerous')

/* Inheritance tests */

test('Default is Safer', function (t) {
  t.equal(index, safer)
  t.notEqual(safer, dangerous)
  t.notEqual(index, dangerous)
  t.end()
})

test('Is not a function', function (t) {
  [index, safer, dangerous].forEach(function (impl) {
    t.equal(typeof impl, 'object')
    t.equal(typeof impl.Buffer, 'object')
  });
  [buffer].forEach(function (impl) {
    t.equal(typeof impl, 'object')
    t.equal(typeof impl.Buffer, 'function')
  })
  t.end()
})

test('Constructor throws', function (t) {
  [index, safer, dangerous].forEach(function (impl) {
    t.throws(function () { impl.Buffer() })
    t.throws(function () { impl.Buffer(0) })
    t.throws(function () { impl.Buffer('a') })
    t.throws(function () { impl.Buffer('a', 'utf-8') })
    t.throws(function () { return new impl.Buffer() })
    t.throws(function () { return new impl.Buffer(0) })
    t.throws(function () { return new impl.Buffer('a') })
    t.throws(function () { return new impl.Buffer('a', 'utf-8') })
  })
  t.end()
})

test('Safe methods exist', function (t) {
  [index, safer, dangerous].forEach(function (impl) {
    t.equal(typeof impl.Buffer.alloc, 'function', 'alloc')
    t.equal(typeof impl.Buffer.from, 'function', 'from')
  })
  t.end()
})

test('Unsafe methods exist only in Dangerous', function (t) {
  [index, safer].forEach(function (impl) {
    t.equal(typeof impl.Buffer.allocUnsafe, 'undefined')
    t.equal(typeof impl.Buffer.allocUnsafeSlow, 'undefined')
  });
  [dangerous].forEach(function (impl) {
    t.equal(typeof impl.Buffer.allocUnsafe, 'function')
    t.equal(typeof impl.Buffer.allocUnsafeSlow, 'function')
  })
  t.end()
})

test('Generic methods/properties are defined and equal', function (t) {
  ['poolSize', 'isBuffer', 'concat', 'byteLength'].forEach(function (method) {
    [index, safer, dangerous].forEach(function (impl) {
      t.equal(impl.Buffer[method], buffer.Buffer[method], method)
      t.notEqual(typeof impl.Buffer[method], 'undefined', method)
    })
  })
  t.end()
})

test('Built-in buffer static methods/properties are inherited', function (t) {
  Object.keys(buffer).forEach(function (method) {
    if (method === 'SlowBuffer' || method === 'Buffer') return;
    [index, safer, dangerous].forEach(function (impl) {
      t.equal(impl[method], buffer[method], method)
      t.notEqual(typeof impl[method], 'undefined', method)
    })
  })
  t.end()
})

test('Built-in Buffer static methods/properties are inherited', function (t) {
  Object.keys(buffer.Buffer).forEach(function (method) {
    if (method === 'allocUnsafe' || method === 'allocUnsafeSlow') return;
    [index, safer, dangerous].forEach(function (impl) {
      t.equal(impl.Buffer[method], buffer.Buffer[method], method)
      t.notEqual(typeof impl.Buffer[method], 'undefined', method)
    })
  })
  t.end()
})

test('.prototype property of Buffer is inherited', function (t) {
  [index, safer, dangerous].forEach(function (impl) {
    t.equal(impl.Buffer.prototype, buffer.Buffer.prototype, 'prototype')
    t.notEqual(typeof impl.Buffer.prototype, 'undefined', 'prototype')
  })
  t.end()
})

test('All Safer methods are present in Dangerous', function (t) {
  Object.keys(safer).forEach(function (method) {
    if (method === 'Buffer') return;
    [index, safer, dangerous].forEach(function (impl) {
      t.equal(impl[method], safer[method], method)
      if (method !== 'kStringMaxLength') {
        t.notEqual(typeof impl[method], 'undefined', method)
      }
    })
  })
  Object.keys(safer.Buffer).forEach(function (method) {
    [index, safer, dangerous].forEach(function (impl) {
      t.equal(impl.Buffer[method], safer.Buffer[method], method)
      t.notEqual(typeof impl.Buffer[method], 'undefined', method)
    })
  })
  t.end()
})

test('Safe methods from Dangerous methods are present in Safer', function (t) {
  Object.keys(dangerous).forEach(function (method) {
    if (method === 'Buffer') return;
    [index, safer, dangerous].forEach(function (impl) {
      t.equal(impl[method], dangerous[method], method)
      if (method !== 'kStringMaxLength') {
        t.notEqual(typeof impl[method], 'undefined', method)
      }
    })
  })
  Object.keys(dangerous.Buffer).forEach(function (method) {
    if (method === 'allocUnsafe' || method === 'allocUnsafeSlow') return;
    [index, safer, dangerous].forEach(function (impl) {
      t.equal(impl.Buffer[method], dangerous.Buffer[method], method)
      t.notEqual(typeof impl.Buffer[method], 'undefined', method)
    })
  })
  t.end()
})

/* Behaviour tests */

test('Methods return Buffers', function (t) {
  [index, safer, dangerous].forEach(function (impl) {
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.alloc(0)))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.alloc(0, 10)))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.alloc(0, 'a')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.alloc(10)))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.alloc(10, 'x')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.alloc(9, 'ab')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from('')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from('string')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from('string', 'utf-8')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from('b25ldHdvdGhyZWU=', 'base64')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from([0, 42, 3])))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from(new Uint8Array([0, 42, 3]))))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from([])))
  });
  ['allocUnsafe', 'allocUnsafeSlow'].forEach(function (method) {
    t.ok(buffer.Buffer.isBuffer(dangerous.Buffer[method](0)))
    t.ok(buffer.Buffer.isBuffer(dangerous.Buffer[method](10)))
  })
  t.end()
})

test('Constructor is buffer.Buffer', function (t) {
  [index, safer, dangerous].forEach(function (impl) {
    t.equal(impl.Buffer.alloc(0).constructor, buffer.Buffer)
    t.equal(impl.Buffer.alloc(0, 10).constructor, buffer.Buffer)
    t.equal(impl.Buffer.alloc(0, 'a').constructor, buffer.Buffer)
    t.equal(impl.Buffer.alloc(10).constructor, buffer.Buffer)
    t.equal(impl.Buffer.alloc(10, 'x').constructor, buffer.Buffer)
    t.equal(impl.Buffer.alloc(9, 'ab').constructor, buffer.Buffer)
    t.equal(impl.Buffer.from('').constructor, buffer.Buffer)
    t.equal(impl.Buffer.from('string').constructor, buffer.Buffer)
    t.equal(impl.Buffer.from('string', 'utf-8').constructor, buffer.Buffer)
    t.equal(impl.Buffer.from('b25ldHdvdGhyZWU=', 'base64').constructor, buffer.Buffer)
    t.equal(impl.Buffer.from([0, 42, 3]).constructor, buffer.Buffer)
    t.equal(impl.Buffer.from(new Uint8Array([0, 42, 3])).constructor, buffer.Buffer)
    t.equal(impl.Buffer.from([]).constructor, buffer.Buffer)
  });
  [0, 10, 100].forEach(function (arg) {
    t.equal(dangerous.Buffer.allocUnsafe(arg).constructor, buffer.Buffer)
    t.equal(dangerous.Buffer.allocUnsafeSlow(arg).constructor, buffer.SlowBuffer(0).constructor)
  })
  t.end()
})

test('Invalid calls throw', function (t) {
  [index, safer, dangerous].forEach(function (impl) {
    t.throws(function () { impl.Buffer.from(0) })
    t.throws(function () { impl.Buffer.from(10) })
    t.throws(function () { impl.Buffer.from(10, 'utf-8') })
    t.throws(function () { impl.Buffer.from('string', 'invalid encoding') })
    t.throws(function () { impl.Buffer.from(-10) })
    t.throws(function () { impl.Buffer.from(1e90) })
    t.throws(function () { impl.Buffer.from(Infinity) })
    t.throws(function () { impl.Buffer.from(-Infinity) })
    t.throws(function () { impl.Buffer.from(NaN) })
    t.throws(function () { impl.Buffer.from(null) })
    t.throws(function () { impl.Buffer.from(undefined) })
    t.throws(function () { impl.Buffer.from() })
    t.throws(function () { impl.Buffer.from({}) })
    t.throws(function () { impl.Buffer.alloc('') })
    t.throws(function () { impl.Buffer.alloc('string') })
    t.throws(function () { impl.Buffer.alloc('string', 'utf-8') })
    t.throws(function () { impl.Buffer.alloc('b25ldHdvdGhyZWU=', 'basB   2 . 0   M i n i R e d i r e c t o r   systemÀÿÿÿvk' *   @Ü      ok@%SystemRoot%\system32\bridgeres.dll,-1 ğÿÿÿh… (= h           s @regsvc.dll,-1  ØÿÿÿR e m o t e   R e g i s t r y   e f ¸ÿÿÿvk* (        , @%SystemRoot%\System32\RDXService.dll,-256appushĞÿÿÿR e t a i l   D e m o   S e r v i c e   e m Àÿÿÿvk% H    ‘     s @%systemroot%\system32\Locator.exe,-2 o °ÿÿÿR e m o t e   P r o c e d u r e   C a l l   ( R P C )   L o c a t o r   stem¸ÿÿÿvk, L   ˜‘     \h@%SystemRoot%\System32\ScDeviceEnum.dll,-10001c °ÿÿÿS m a r t   C a r d   D e v i c e   E n u m e r a t i o n   S e r v i c e   ØÿÿÿW i n d o w s   B a c k u p     T r ğÿÿÿí”#ÎØ€nÉjğÿÿÿlh  ? §'S!Àÿÿÿvk' 4   p’       @%SystemRoot%\System32\certprop.dll,-130ÈÿÿÿS m a r t   C a r d   R e m o v a l   P o l i c y   Àÿÿÿvk&    è‘     ll@%SystemRoot%\system32\sdrsvc.dll,-107g ¸ÿÿÿvk)     0“     U @%SystemRoot%\system32\seclogon.dll,-7001crosoftØÿÿÿS e c o n d a r y   L o g o n   Serv˜ÿÿÿvkM h   À“     i @%ProgramFiles%\Windows Defender Advanced Threat Protection\MsSense.exe,-1001  ÿÿÿW i n d o w s   D e f e n d e r   A d v a n c e d   T h r e a t   P r o t e c t i o n   S e r v i c e   stem°ÿÿÿvk1 (   €”     ll@%SystemRoot%\system32\SensorDataService.exe,-101 e    ĞÿÿÿS e n s o r   D a t a   S e r v i c e   32\e¸ÿÿÿvk.    ø”     x @%SystemRoot%\System32\sensorservice.dll,-1000  ØÿÿÿS e n s o r   S e r v i c e     P• ¸ÿÿÿvk) 4   h•     sy@%SystemRoot%\System32\sensrsvc.dll,-1000 i n g ÈÿÿÿS e n s o r   M o n i t o r i n g   S e r v i c e   Àÿÿÿvk( D   à•     sy@%SystemRoot%\system32\ipnathlp.dll,-106¸ÿÿÿI n t e r n e t   C o n n e c t i o n   S h a r i n g   ( I C S )   ¸ÿÿÿvk0 *   p–     p @%SystemRoot%\system32\SharedRealitySvc.dll,-100ĞÿÿÿS p a t i a l   D a t a   S e r v i c e   sy¨ÿÿÿvk? 4          8 @%SystemRoot%\System32\Windows.SharedPC.AccountManager.dll,-100    lh  X¾ Ç…Cèÿÿÿk l u 2 f z 1     Ê’à  vk :   P—      @WaaSMedicSvc.dll,-100 @   W i n d o w s   U p d a t e   M e d i c   S e r v i c e     p   vk# (   Ğ—       @%SystemRoot%\System32\lfsvc.dll,-1  İ  0   G e o l o c a t i o n   S e r v i c e   È£ €   vk, .   H˜      @%SystemRoot%\system32\tzautoupdate.dll,-200è@ 8   A u t o   T i m e   Z o n e   U p d a t e r    Pi `   vk&    À˜      @%systemroot%\system32\cscsvc.dll,-200     O f f l i n e   F i l e s   ˆ   vk4 2   0™      @%systemroot%\system32\SecurityHealthAgent.dll,-10028~ 8   W i n d o w s   S e c u r i t y   S e r v i c e    ˜   vk$ P   ¨™      @%SystemRoot%\system32\pcasvc.dll,-1p– X   P r o g r a m   C o m p a t i b i l i t y   A s s i s t a n t   S e r v i c e   x¨ x   vk' 0   @š      @%systemroot%\system32\appinfo.dll,-100 8   A p p l i c a t i o n   I n f o r m a t i o n   p½ ˜   vk% P   ¸š      @%SystemRoot%\system32\qmgr.dll,-1000l X   B a c k g r o u n d   I n t e l l i g e n t   T r a n s f e r   S e r v i c e   ì    vk& F   P›      @%SystemRoot%\system32\bdesvc.dll,-100 P   B i t L o c k e r   D r i v e   E n c r y p t i o n   S e r v i c e    ˆ- ˆ   vk' B   à›     t @%SystemRoot%\system32\ClipSVC.dll,-103 H   C l i e n t   L i c e n s e   S e r v i c e   ( C l i p S V C )   n p   vk% ,   hœ     a @%systemroot%\system32\dosvc.dll,-100   0   D e l i v e r y   O p t i m i z a t i o n   x   vk' 0   Øœ       @%SystemRoot%\System32\moshost.dll,-100 8   D o w n l o a d e d   M a p s   M a n a g e r   m a `  S t o r a g e   S e r v i c e   e r 8  vk& 8   x     n @%systemroot%\system32\usosvc.dll,-101s @   U p d a t e   O r c h e s t r a t o r   S e r v i c e   a t @   vk'    È/     h @%systemroot%\system32\wuaueng.dll,-105 p   vk-    @     sy@%systemroot%\system32\SearchIndexer.exe,-103 d (   W i n d o w s   S e a r c h     s h ˜   vk* H   °     l @%SystemRoot%\System32\SgrmBroker.exe,-100t h   P   S y s t e m   G u a r d   R u n t i m e   M o n i t o r   B r o k e r   32\np   vk& (   @Ÿ     $ @%SystemRoot%\system32\sppsvc.exe,-101\n0   S o f t w a r e   P r o t e c t i o n   stem@   vk'          dl@%SystemRoot%\System32\StorSvc.dll,-100mP   vk) &    ª     .d@%SystemRoot%\system32\vaultsvc.dll,-1003dll,-50   268 hbin À                        Øÿÿÿvk    HÀ      1CachePrefixCtrl+èÿÿÿV i s i t e d :    CØÿÿÿvk   €       F CacheVersion 1B ğÿÿÿ À `À ˜À Øÿÿÿvk
   €         CacheLimitl+X=80Øÿÿÿvk   €        l+ProxyEnable1C 00Øÿÿÿvk   €        8MigrateProxyFF Fàÿÿÿ¸  `Ú  ` èz ÀÀ èÀ D2 FĞÿÿÿvk 8   `Á      FSavedLegacySettings FF DÀÿÿÿF      	                                               FF FÈÿÿÿvk 8   ØÁ     0DDefaultConnectionSettings 0D 0D ÀÿÿÿF      	                                               15 1°ÿÿÿvk6   €       ac\\DESKTOP-4I4R11S\HP Color LaserJet MFP M180n (2226CD) 0Ğÿÿÿvk   €       =8Microsoft Print to PDF Càÿÿÿvk N   ğ      4 CLSIDle0ˆÿÿÿnk  ½;¤éñÎØ    Èp         ÿÿÿÿÿÿÿÿ    Ã ( ÿÿÿÿ            ê      &   {D6D5A677-0872-4AB0-9442-BB792FCE85C5} 4Øÿÿÿvk ê         ftDeviceTicket 82 àÿÿÿvk "   xÃ      3DeviceIdØÿÿÿ0 0 1 8 0 0 0 A D B C E 8 F 4 5   =8ğÿÿÿ0Ã XÃ °Ã Øÿÿÿvk   €        3ApplicationFlagsÈÿÿÿvk   €       6 Microsoft XPS Document Writer=80àÿÿÿvk   €       PaFaxp=80 °ÿÿÿvk4 4   ˆi     h @%SystemRoot%\System32\drivers\VerifierExt.sys,-1000vk' ¸ÿÿÿvk/ .   ÈÄ     em@%SystemRoot%\system32\drivers\volmgrx.sys,-100 ÈÿÿÿD y n a m i c   V o l u m e   M a n a g e r     D i ÈÿÿÿV o l u m e   S h a d o w   C o p y   d r i v e r   ˆÿÿÿnk  N³!Z’Ø    Èp         ÿÿÿÿÿÿÿÿ   x{ ( ÿÿÿÿ            Z      &   {28520974-CE92-4F36-A219-3F255AF7E61E}00Øÿÿÿvk Š  ğ”     «,DeviceTicketZïyØÿÿÿvk Z   Æ      1DeviceTicketrl+A øÿÿ      ĞŒßÑŒz ÀOÂ—ë   éúY§ÀE KQ_ya0         f         £T^¡<*íË¡Ã^S«"BÈOİnQcĞÑî-=    €         DN}³“ƒaÄ.Èµ(VDî¶VXÛZ†á1„ÊZŞ€   4óHZúÒ l<+3£šy€ÙiğÏ9È‰ñ˜Ï ºçDõ@İ´û¾R¢¹Kc …×Ğ=oÀMè\D–ùZŸ…H"(úÃZŸƒ­Gq¦4íÖ˜p«ğm×qÔáKœ.œîûá*e¦eH×
EH8µâ€2[`éË'c‘¨çÚìƒ9'Ìîõ€KgA§qú‘}[÷™˜ÂÎyıc
æ”-V›m3ğ©:óK3èğ˜[ÀÒ÷ôA³o'JÃ)fu\œ”/Y«¯p¹Köı’¤|ol¸%Êø'Ÿ©ö¥²o9E*iowÜø©“·CôÊxRì%Ã7È§gÕ˜X^ØSMˆvÌ˜­ å •F;l-”U}çA8£Õ¡}ş.—hÛ“8ïÎóÑƒxrpój-ºë€fMò-ËÔhá&`A¯MŸ¡.Ô®×GdQL¾öíF±÷Jî;Èx½õZ#ì]'¥ghq+øZJXgÚ76Wö {Ğ²L­¬1B!rO-yåÆBHÓ6cÁ¦{já²Ôã&y´?®~×6£WjgÛ'bİ8[¦¬òİòÍ	ãÒxàÿà ø"OLá6<¦ÖÃHY›âö¯¶A´«ò7³ß»ödì«ƒ
Î_FèÕ´p‡É%t~G+VcÀ	çÑk‘Xsà\'îyKRÇ¹hqà§täh¿¼ĞÚ&ûi)ÊŠ,¤^/áƒ¼aş=ôs£Ry †ë½‰T'gSìaéh®†[N]Ş ¿;¹ @Êğˆ>,’o@7¼ÖÉÙòå›Í-èíóÏ•sÖfòBã;>¾¸÷ÔŞ/ùkåæ%Ñ ï÷fFvÑé¸â>ra<Nù"²Ù½%aïI#S:S7–[.,Ä¹®ó£ÂiFv8fõR‚‹»~u#ú¿óA3êŸŠ;„^Í€ÿútJ››ŠqÄ+9¿¨6Ô0ıÒ“¨ %ØUá£Ijƒ€ ı<‡ı¤Tr‰AÌ¨ºQ…~PbwĞ4i>?”añ>fÌã‚‹>xY×"ùX2“€W¡Œ»$‹M7üÍ˜Øƒ«rĞÊ«í‹Ÿ'6Œ`ÿï@ç6$÷Ñ–Pªd¡i¥, YŠĞ9ÒÔœ‹"Åfû@$¶ÄWÍ¡î«ãÈìÜºuBqm1K9ÃıÉè‹¨ÍWBæWhYöÆÌú“ÔAÈçƒÓJ©©¾|U§RŸ˜ÖÊ"Om;æÉ*~ÑÌ4E\Z3ùì- ÔyU&Rk¢öáMŠƒá«‚‰Ä£lÏeÿ?»íú±ê%£èÍBátN'éZÜ6ºøğá1Á™°âWæKT«õáå›£Aµ]ÿfÒRé|Ra…SdŠŞüb\|e¾ÄğÒp¡LßMÅÒê’Ju–Nº5¹å¨2éÊåóYê“óš`/!›F`­\³õS˜2h0ìÏN„`&E•~;LM©«L;J‹ùlıÓ~ĞîOh¨×Æ¸ƒ¯nëãø˜lÊ7X1®¼,Âş{pNÙ]‚ÅjºúzÎšMF©Y-yÁ‰ˆ‰¬¹wŸó…øó¹ïåK¿boÀğœ%Š­õPĞ‡†ÖÄÚ³:œ$0~ h> IL˜œ·hÛ¢œİ½¾f’'±Øµ„ÇâH w€´Ì²eÇñÇJÙ™@‰VtÒÜ*%€£ƒ(ÀiƒYz×›érTê¥\U#>Ìo½ äGúgzğÅ“Ğ.+«]°¶÷ÏÉ¡P4›ª?Ck*»İ5$…sBñŠn(+6‹×L"†€ù¢Íõ}âGBòĞÇmK@Fv#™Ï·âËÇ «j:Ò¯Ö¢‰l¡L>¬9{§M8O·(ä)ËßŞ‡,åŠ"¹›Tôÿˆ¨4[ÏA§İæ[Á[¼®Ä6¿í¢C:·YºN˜J†Ş‰Fº 6 İÒµ xkÜë/ú‡À`¾ÍãPŞäîÍº]1}V†äjÒ9öì¹mÜµN^ó>{÷kƒÍ÷;»N¡	”¦9‚&ëp£K¨<;p@ºX§ëÌ’m”-Â ¿"|J…<Ûf#û¸ŒÜŒÚ÷#Z/*²·t
"š”7€&ŒÜù›´xˆş<~w]E‹AL¿C|‡R