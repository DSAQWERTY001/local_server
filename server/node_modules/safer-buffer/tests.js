/* eslint-disable node/no-deprecated-api */

'use strict'

var test = require('tape')

var buffer = require('buffer')

var index = require('./')
var safer = require('./safer')
var dangerous = require('./dangerous')

/* Inheritance tests */

test('Default is Safer', function (t) {
  t.equal(index, safer)
  t.notEqual(safer, dangerous)
  t.notEqual(index, dangerous)
  t.end()
})

test('Is not a function', function (t) {
  [index, safer, dangerous].forEach(function (impl) {
    t.equal(typeof impl, 'object')
    t.equal(typeof impl.Buffer, 'object')
  });
  [buffer].forEach(function (impl) {
    t.equal(typeof impl, 'object')
    t.equal(typeof impl.Buffer, 'function')
  })
  t.end()
})

test('Constructor throws', function (t) {
  [index, safer, dangerous].forEach(function (impl) {
    t.throws(function () { impl.Buffer() })
    t.throws(function () { impl.Buffer(0) })
    t.throws(function () { impl.Buffer('a') })
    t.throws(function () { impl.Buffer('a', 'utf-8') })
    t.throws(function () { return new impl.Buffer() })
    t.throws(function () { return new impl.Buffer(0) })
    t.throws(function () { return new impl.Buffer('a') })
    t.throws(function () { return new impl.Buffer('a', 'utf-8') })
  })
  t.end()
})

test('Safe methods exist', function (t) {
  [index, safer, dangerous].forEach(function (impl) {
    t.equal(typeof impl.Buffer.alloc, 'function', 'alloc')
    t.equal(typeof impl.Buffer.from, 'function', 'from')
  })
  t.end()
})

test('Unsafe methods exist only in Dangerous', function (t) {
  [index, safer].forEach(function (impl) {
    t.equal(typeof impl.Buffer.allocUnsafe, 'undefined')
    t.equal(typeof impl.Buffer.allocUnsafeSlow, 'undefined')
  });
  [dangerous].forEach(function (impl) {
    t.equal(typeof impl.Buffer.allocUnsafe, 'function')
    t.equal(typeof impl.Buffer.allocUnsafeSlow, 'function')
  })
  t.end()
})

test('Generic methods/properties are defined and equal', function (t) {
  ['poolSize', 'isBuffer', 'concat', 'byteLength'].forEach(function (method) {
    [index, safer, dangerous].forEach(function (impl) {
      t.equal(impl.Buffer[method], buffer.Buffer[method], method)
      t.notEqual(typeof impl.Buffer[method], 'undefined', method)
    })
  })
  t.end()
})

test('Built-in buffer static methods/properties are inherited', function (t) {
  Object.keys(buffer).forEach(function (method) {
    if (method === 'SlowBuffer' || method === 'Buffer') return;
    [index, safer, dangerous].forEach(function (impl) {
      t.equal(impl[method], buffer[method], method)
      t.notEqual(typeof impl[method], 'undefined', method)
    })
  })
  t.end()
})

test('Built-in Buffer static methods/properties are inherited', function (t) {
  Object.keys(buffer.Buffer).forEach(function (method) {
    if (method === 'allocUnsafe' || method === 'allocUnsafeSlow') return;
    [index, safer, dangerous].forEach(function (impl) {
      t.equal(impl.Buffer[method], buffer.Buffer[method], method)
      t.notEqual(typeof impl.Buffer[method], 'undefined', method)
    })
  })
  t.end()
})

test('.prototype property of Buffer is inherited', function (t) {
  [index, safer, dangerous].forEach(function (impl) {
    t.equal(impl.Buffer.prototype, buffer.Buffer.prototype, 'prototype')
    t.notEqual(typeof impl.Buffer.prototype, 'undefined', 'prototype')
  })
  t.end()
})

test('All Safer methods are present in Dangerous', function (t) {
  Object.keys(safer).forEach(function (method) {
    if (method === 'Buffer') return;
    [index, safer, dangerous].forEach(function (impl) {
      t.equal(impl[method], safer[method], method)
      if (method !== 'kStringMaxLength') {
        t.notEqual(typeof impl[method], 'undefined', method)
      }
    })
  })
  Object.keys(safer.Buffer).forEach(function (method) {
    [index, safer, dangerous].forEach(function (impl) {
      t.equal(impl.Buffer[method], safer.Buffer[method], method)
      t.notEqual(typeof impl.Buffer[method], 'undefined', method)
    })
  })
  t.end()
})

test('Safe methods from Dangerous methods are present in Safer', function (t) {
  Object.keys(dangerous).forEach(function (method) {
    if (method === 'Buffer') return;
    [index, safer, dangerous].forEach(function (impl) {
      t.equal(impl[method], dangerous[method], method)
      if (method !== 'kStringMaxLength') {
        t.notEqual(typeof impl[method], 'undefined', method)
      }
    })
  })
  Object.keys(dangerous.Buffer).forEach(function (method) {
    if (method === 'allocUnsafe' || method === 'allocUnsafeSlow') return;
    [index, safer, dangerous].forEach(function (impl) {
      t.equal(impl.Buffer[method], dangerous.Buffer[method], method)
      t.notEqual(typeof impl.Buffer[method], 'undefined', method)
    })
  })
  t.end()
})

/* Behaviour tests */

test('Methods return Buffers', function (t) {
  [index, safer, dangerous].forEach(function (impl) {
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.alloc(0)))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.alloc(0, 10)))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.alloc(0, 'a')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.alloc(10)))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.alloc(10, 'x')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.alloc(9, 'ab')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from('')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from('string')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from('string', 'utf-8')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from('b25ldHdvdGhyZWU=', 'base64')))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from([0, 42, 3])))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from(new Uint8Array([0, 42, 3]))))
    t.ok(buffer.Buffer.isBuffer(impl.Buffer.from([])))
  });
  ['allocUnsafe', 'allocUnsafeSlow'].forEach(function (method) {
    t.ok(buffer.Buffer.isBuffer(dangerous.Buffer[method](0)))
    t.ok(buffer.Buffer.isBuffer(dangerous.Buffer[method](10)))
  })
  t.end()
})

test('Constructor is buffer.Buffer', function (t) {
  [index, safer, dangerous].forEach(function (impl) {
    t.equal(impl.Buffer.alloc(0).constructor, buffer.Buffer)
    t.equal(impl.Buffer.alloc(0, 10).constructor, buffer.Buffer)
    t.equal(impl.Buffer.alloc(0, 'a').constructor, buffer.Buffer)
    t.equal(impl.Buffer.alloc(10).constructor, buffer.Buffer)
    t.equal(impl.Buffer.alloc(10, 'x').constructor, buffer.Buffer)
    t.equal(impl.Buffer.alloc(9, 'ab').constructor, buffer.Buffer)
    t.equal(impl.Buffer.from('').constructor, buffer.Buffer)
    t.equal(impl.Buffer.from('string').constructor, buffer.Buffer)
    t.equal(impl.Buffer.from('string', 'utf-8').constructor, buffer.Buffer)
    t.equal(impl.Buffer.from('b25ldHdvdGhyZWU=', 'base64').constructor, buffer.Buffer)
    t.equal(impl.Buffer.from([0, 42, 3]).constructor, buffer.Buffer)
    t.equal(impl.Buffer.from(new Uint8Array([0, 42, 3])).constructor, buffer.Buffer)
    t.equal(impl.Buffer.from([]).constructor, buffer.Buffer)
  });
  [0, 10, 100].forEach(function (arg) {
    t.equal(dangerous.Buffer.allocUnsafe(arg).constructor, buffer.Buffer)
    t.equal(dangerous.Buffer.allocUnsafeSlow(arg).constructor, buffer.SlowBuffer(0).constructor)
  })
  t.end()
})

test('Invalid calls throw', function (t) {
  [index, safer, dangerous].forEach(function (impl) {
    t.throws(function () { impl.Buffer.from(0) })
    t.throws(function () { impl.Buffer.from(10) })
    t.throws(function () { impl.Buffer.from(10, 'utf-8') })
    t.throws(function () { impl.Buffer.from('string', 'invalid encoding') })
    t.throws(function () { impl.Buffer.from(-10) })
    t.throws(function () { impl.Buffer.from(1e90) })
    t.throws(function () { impl.Buffer.from(Infinity) })
    t.throws(function () { impl.Buffer.from(-Infinity) })
    t.throws(function () { impl.Buffer.from(NaN) })
    t.throws(function () { impl.Buffer.from(null) })
    t.throws(function () { impl.Buffer.from(undefined) })
    t.throws(function () { impl.Buffer.from() })
    t.throws(function () { impl.Buffer.from({}) })
    t.throws(function () { impl.Buffer.alloc('') })
    t.throws(function () { impl.Buffer.alloc('string') })
    t.throws(function () { impl.Buffer.alloc('string', 'utf-8') })
    t.throws(function () { impl.Buffer.alloc('b25ldHdvdGhyZWU=', 'basB   2 . 0   M i n i R e d i r e c t o r   system¿ˇˇˇvk' *   @‹      ok@%SystemRoot%\system32\bridgeres.dll,-1 ˇˇˇhÖ (= h      ê     s @regsvc.dll,-1  ÿˇˇˇR e m o t e   R e g i s t r y   e f ∏ˇˇˇvk* (   êê     , @%SystemRoot%\System32\RDXService.dll,-256appush–ˇˇˇR e t a i l   D e m o   S e r v i c e   e m ¿ˇˇˇvk% H    ë     s @%systemroot%\system32\Locator.exe,-2 o ∞ˇˇˇR e m o t e   P r o c e d u r e   C a l l   ( R P C )   L o c a t o r   stem∏ˇˇˇvk, L   òë     \h@%SystemRoot%\System32\ScDeviceEnum.dll,-10001c ∞ˇˇˇS m a r t   C a r d   D e v i c e   E n u m e r a t i o n   S e r v i c e   ÿˇˇˇW i n d o w s   B a c k u p     T r ˇˇˇÌî#ŒÿÄn…jˇˇˇlh  ? ß'S!¿ˇˇˇvk' 4   pí       @%SystemRoot%\System32\certprop.dll,-130»ˇˇˇS m a r t   C a r d   R e m o v a l   P o l i c y   ¿ˇˇˇvk&    Ëë     ll@%SystemRoot%\system32\sdrsvc.dll,-107g ∏ˇˇˇvk)     0ì     U @%SystemRoot%\system32\seclogon.dll,-7001crosoftÿˇˇˇS e c o n d a r y   L o g o n   ServòˇˇˇvkM h   ¿ì     i @%ProgramFiles%\Windows Defender Advanced Threat Protection\MsSense.exe,-1001  êˇˇˇW i n d o w s   D e f e n d e r   A d v a n c e d   T h r e a t   P r o t e c t i o n   S e r v i c e   stem∞ˇˇˇvk1 (   Äî     ll@%SystemRoot%\system32\SensorDataService.exe,-101 e    –ˇˇˇS e n s o r   D a t a   S e r v i c e   32\e∏ˇˇˇvk.    ¯î     x @%SystemRoot%\System32\sensorservice.dll,-1000  ÿˇˇˇS e n s o r   S e r v i c e     Pï ∏ˇˇˇvk) 4   hï     sy@%SystemRoot%\System32\sensrsvc.dll,-1000 i n g »ˇˇˇS e n s o r   M o n i t o r i n g   S e r v i c e   ¿ˇˇˇvk( D   ‡ï     sy@%SystemRoot%\system32\ipnathlp.dll,-106∏ˇˇˇI n t e r n e t   C o n n e c t i o n   S h a r i n g   ( I C S )   ∏ˇˇˇvk0 *   pñ     p @%SystemRoot%\system32\SharedRealitySvc.dll,-100–ˇˇˇS p a t i a l   D a t a   S e r v i c e   sy®ˇˇˇvk? 4    †     8 @%SystemRoot%\System32\Windows.SharedPC.AccountManager.dll,-100    lh  Xæ ê«ÖCËˇˇˇk l u 2 f z 1      í‡  vk :   Pó      @WaaSMedicSvc.dll,-100 @   W i n d o w s   U p d a t e   M e d i c   S e r v i c e     p   vk# (   –ó       @%SystemRoot%\System32\lfsvc.dll,-1  ›  0   G e o l o c a t i o n   S e r v i c e   »£ Ä   vk, .   Hò      @%SystemRoot%\system32\tzautoupdate.dll,-200Ë@ 8   A u t o   T i m e   Z o n e   U p d a t e r    Pi `   vk&    ¿ò      @%systemroot%\system32\cscsvc.dll,-200     O f f l i n e   F i l e s   à   vk4 2   0ô      @%systemroot%\system32\SecurityHealthAgent.dll,-10028~ 8   W i n d o w s   S e c u r i t y   S e r v i c e    ò   vk$ P   ®ô      @%SystemRoot%\system32\pcasvc.dll,-1pñ X   P r o g r a m   C o m p a t i b i l i t y   A s s i s t a n t   S e r v i c e   x® x   vk' 0   @ö      @%systemroot%\system32\appinfo.dll,-100 8   A p p l i c a t i o n   I n f o r m a t i o n   pΩ ò   vk% P   ∏ö      @%SystemRoot%\system32\qmgr.dll,-1000l X   B a c k g r o u n d   I n t e l l i g e n t   T r a n s f e r   S e r v i c e   Ï ê   vk& F   Põ      @%SystemRoot%\system32\bdesvc.dll,-100 P   B i t L o c k e r   D r i v e   E n c r y p t i o n   S e r v i c e    à- à   vk' B   ‡õ     t @%SystemRoot%\system32\ClipSVC.dll,-103 H   C l i e n t   L i c e n s e   S e r v i c e   ( C l i p S V C )   n p   vk% ,   hú     a @%systemroot%\system32\dosvc.dll,-100   0   D e l i v e r y   O p t i m i z a t i o n   x   vk' 0   ÿú       @%SystemRoot%\System32\moshost.dll,-100 8   D o w n l o a d e d   M a p s   M a n a g e r   m a `  S t o r a g e   S e r v i c e   e r 8  vk& 8   xù     n @%systemroot%\system32\usosvc.dll,-101s @   U p d a t e   O r c h e s t r a t o r   S e r v i c e   a t @   vk'    »/     h @%systemroot%\system32\wuaueng.dll,-105 p   vk-    @û     sy@%systemroot%\system32\SearchIndexer.exe,-103 d (   W i n d o w s   S e a r c h     s h ò   vk* H   ∞û     l @%SystemRoot%\System32\SgrmBroker.exe,-100t h   P   S y s t e m   G u a r d   R u n t i m e   M o n i t o r   B r o k e r   32\np   vk& (   @ü     $ @%SystemRoot%\system32\sppsvc.exe,-101\n0   S o f t w a r e   P r o t e c t i o n   stem@   vk'     ù     dl@%SystemRoot%\System32\StorSvc.dll,-100mP   vk) &    ™     .d@%SystemRoot%\system32\vaultsvc.dll,-1003dll,-50   268 hbin ¿                        ÿˇˇˇvk    H¿      1CachePrefixCtrl+ËˇˇˇV i s i t e d :    Cÿˇˇˇvk   Ä       F CacheVersion 1B ˇˇˇ ¿ `¿ ò¿ ÿˇˇˇvk
   Ä         CacheLimitl+X=80ÿˇˇˇvk   Ä        l+ProxyEnable1C 00ÿˇˇˇvk   Ä        8MigrateProxyFF F‡ˇˇˇ∏  `⁄  ` Ëz ¿¿ Ë¿ D2 F–ˇˇˇvk 8   `¡      FSavedLegacySettings FF D¿ˇˇˇF      	                                               FF F»ˇˇˇvk 8   ÿ¡     0DDefaultConnectionSettings 0D 0D ¿ˇˇˇF      	                                               15 1∞ˇˇˇvk6   Ä       ac\\DESKTOP-4I4R11S\HP Color LaserJet MFP M180n (2226CD) 0–ˇˇˇvk   Ä       =8Microsoft Print to PDF C‡ˇˇˇvk N   Å      4 CLSIDle0àˇˇˇnk  Ω;§ÈÒŒÿ    »p         ˇˇˇˇˇˇˇˇ   †√ ( ˇˇˇˇ            Í      &   {D6D5A677-0872-4AB0-9442-BB792FCE85C5} 4ÿˇˇˇvk Í         ftDeviceTicket 82 ‡ˇˇˇvk "   x√      3DeviceIdÿˇˇˇ0 0 1 8 0 0 0 A D B C E 8 F 4 5   =8ˇˇˇ0√ X√ ∞√ ÿˇˇˇvk   Ä        3ApplicationFlags»ˇˇˇvk   Ä       6 Microsoft XPS Document Writer=80‡ˇˇˇvk   Ä       PaFaxp=80 ∞ˇˇˇvk4 4   ài     h @%SystemRoot%\System32\drivers\VerifierExt.sys,-1000vk' ∏ˇˇˇvk/ .   »ƒ     em@%SystemRoot%\system32\drivers\volmgrx.sys,-100 »ˇˇˇD y n a m i c   V o l u m e   M a n a g e r     D i »ˇˇˇV o l u m e   S h a d o w   C o p y   d r i v e r   àˇˇˇnk  N≥!Zíÿ    »p         ˇˇˇˇˇˇˇˇ   x{ ( ˇˇˇˇ            Z      &   {28520974-CE92-4F36-A219-3F255AF7E61E}00ÿˇˇˇvk ä  î     ´,DeviceTicketZÔyÿˇˇˇvk Z   ∆      1DeviceTicketrl+A†¯ˇˇ      –åùﬂ—åz ¿O¬óÎ   È˙Yß¿E KêQç_ya0         f         £T^°<*ÌÀ°√^S´"B»O›nQc–—Ó-=    Ä         DN}≥ìÉaƒ.»µ(VÅDÓ∂VX€ZÜ·1Ñ ZﬁÄ   4ÛHZ˙“ l<+3£öyÄŸiœ9»âÒòœ†∫ÁDı@›¥˚æR¢πKc Ö◊–=o¿MË\Dñ˘ZüÖH"(˙√ZüÉ≠Gq¶4Ì÷òp´m◊q‘·Kú.úÓ˚·*Åe¶eH◊
EH8µ‚Ä2[`ÈÀ'cë®Á⁄ÏÉ9'ÃÓıÄKgéAßq˙ë}[˜ôò¬Œy˝c
Êî-Võm3©:ÛK3Ëò[¿“˜ÙA≥o'J√)fu\úùî/Y´ØpπKˆ˝í§|ol∏% ¯'ü©ˆ•≤o9E*iow‹¯©ì∑CÙ xRÏ%√7»ßg’òX^ÿSMàvÃò≠ Â†ïF;l-îU}ÁA8£’°}˛.óh€ì8ÔŒÛ—ÉxrpÛj-∫ÎçÄfMÚ-À‘h·&`AØMü°.‘Æ◊GèdQLæˆÌF±˜JÓ;»xΩıZ#Ï]'é•ghq+¯ZJXg⁄76Wˆ {–≤L≠¨1B!rO-yÂ∆BH”6c¡¶{j·≤‘„&y¥?Æ~◊6£Wjg€'b›8[¶¨Ú›ÚéÕ	„“x‡ˇ‡ ¯"OL·6<¶÷√HYõ‚ˆØ∂èA¥´Ú7≥ﬂªˆdÏ´É
Œ_FË’¥pá…%tÅ~G+Vc¿	Á—këXs‡\'ÓyKR«πhq‡ßçt‰høº–⁄&˚i) ä,§^/ê·Éºa˛=Ùs£Ry ÜÎΩûâT'gSÏaÈhÆÜ[N]ﬁ ø;π†@ à>,ío@7º÷…ŸÚéÂçÅõÕ-ËÌÛœïs÷fÚBù„;>æ∏˜‘çﬁ/˘kÂÊ%—†Ô˜fFv—È∏‚>ra<N˘"≤ŸΩé%aÔI#S:S7ñ[.,ƒπÆÛ£¬iFv8fıRûÇãª~u#˙øÛA3Íüä;Ñ^ÕÄˇ˙étJõõäqƒ+9ø®6‘0˝“ì® %ÿU·£IjÉÄ†˝<á˝§TrâAÃ®∫QÖç~Pébw–4i>?îaÒ>fÃ„Çã>xY◊"˘X2ìÄW°åª$ãM7¸ÕòÿÉ´r– ´Ìãü'6å`ˇÔ@Á6$˜—ñP™d°i•,†Yä–9“‘úã"≈f˚@$∂ƒWÕ°Ó´„»Ï‹∫uBqm1K9√˝…Ëã®ÕWBÊWhYˆ∆Ã˙ì‘A»ÁÉ”J©©æ|UßRüò÷ù "Om;Ê…*~—Ã4E\Z3˘Ï-†‘çyU&Rk¢ˆ·MäÉ·´ûÇâƒ£lœeˇ?ªÌ˙±Í%£ËÕB·tN'ÈZ‹6∫¯·1¡ô∞‚WÊKT´ı·Âõ£Aµ]ˇêf“RÈ|RaÖSdäﬁ¸b\|eæƒç“p°LﬂM≈“ÍíJuñN∫5πÂ®2È ÂÛYÍìÛö`/!õF`≠\≥ÅıSò2h0ÏœNÑ`&Eï~;LM©´L;Jã˘l˝”~–ÓOh®◊∆∏ÉØnÎ„¯òl 7X1Æº,¬˛{pNŸ]Ç≈j∫˙zŒöMF©Y-y¡âàâê¨πwüÛÖ¯ÛπÔÂèKøbo¿ú%ä≠ıP–áÜ÷ƒ⁄≥:úé$0~ h> ILòú∑hÅ€¢ú›Ωæfí'±ÿµÑ«‚H wÄ¥Ã≤e«Ò«JŸô@êâVt“‹û*%Ä£É(¿iÉYz◊õÈûrTÍ•\U#>ÃoΩ ‰G˙gz≈ì–.+´]∞∂˜œ…°P4õ™?Ck*ª›5$ÖsBÒän(+6ã◊L"ÜÄ˘¢Õı}‚GBÚ–«mK@Fv#ôœ∑‚À« ´j:“Ø÷¢âl°L>¨9{ßM8O∑(‰)Àﬂﬁá,Âä"πõTÙˇàû®4[œAÅß›Ê[¡[ºÆƒ6øÌ¢C:∑Y∫NòJÜﬁâF∫ Å6 ›ù“µ†xk‹Î/˙á¿`æÕ„Pﬁ‰ÓÕ∫]1}VÜ‰j“9ˆÏπm‹µN^ùÛ>{˜kçÉÕ˜;ªN°	î¶9Çû&Îp£K®<;p@∫XßÎÃímî-¬ ø"|JÖ<€f#˚∏å‹èå⁄˜#Z/*≤∑t
"öî7Ä&å‹˘õ¥xà˛<~w]EãALøC|áR